<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kosh</title>
    <!-- Favicon and Web App Manifest -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'notion-bg': '#0f0f0f',
                        'notion-card': '#1a1a1a',
                        'notion-border': '#2a2a2a',
                        'notion-text': '#f1f1f1',
                        'notion-text-secondary': '#9ca3af',
                        'notion-accent': '#1e90ff',
                        'notion-accent-hover': '#0066cc',
                        'notion-input': '#2a2a2a',
                        'notion-hover': '#252525'
                    },
                    fontFamily: {
                        'title': ['Space Grotesk', 'sans-serif'],
                        'content': ['Sora', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    }
                }
            }
        }
    </script>
    
    <style>
        * { font-family: 'Sora', sans-serif; }
        h1, h2, h3, h4, h5, h6, .title-font { font-family: 'Space Grotesk', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .notion-shadow { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background: #1e90ff; transition: none; }
        .btn-primary:hover { background: #0066cc; }
        .btn-secondary { background: rgba(255, 255, 255, 0.05); transition: none; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-primary:focus, .btn-secondary:focus {
            outline: 2px solid #1e90ff;
            outline-offset: 2px;
        }
        tbody tr:nth-child(even) { background-color: #181818; }
        tbody tr:hover { background-color: #252525; }
        th { padding-top: 24px !important; padding-bottom: 24px !important; }
    </style>
</head>
<body class="bg-notion-bg text-notion-text font-content min-h-screen">
    <!-- Top Navigation -->
    <nav class="border-b border-notion-border bg-notion-bg/95 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg overflow-hidden flex items-center justify-center">
                        <img src="/static/android-chrome-512x512.png" alt="Kosh Logo" class="w-full h-full object-cover">
                    </div>
                    <h1 class="text-xl font-semibold text-notion-text font-title">Kosh Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-notion-accent hover:text-white flex items-center" style="gap:.5rem;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18M9 6l-6 6 6 6"/>
                        </svg>
                        <span>User Dashboard</span>
                    </a>
                    <a href="/logout" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-notion-text hover:text-white flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Sign out</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8 animate-slide-up">
        <div class="mb-12">
            <h2 class="text-3xl font-bold text-notion-text mb-2 font-title">Admin Dashboard</h2>
            <p class="text-notion-text-secondary text-lg font-content">Manage all users, attributes, and file policies on the network.</p>
        </div>
    <div class="flex flex-col gap-8">
            <!-- Users Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="mb-2 md:mb-0">
                            <h3 class="text-2xl font-semibold text-notion-text font-title flex items-center mb-2">
                                Users & Attributes
                                <span title="Manage users and their attributes" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-base mt-1">Add, edit, or remove users and set their attributes.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <button onclick="openUserModal()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center" aria-label="Add User">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </span>
                                <span>Add User</span>
                            </button>
                            <label for="attr-filter" class="sr-only">Filter by attribute</label>
                            <div class="relative ml-2">
                                <select id="attr-filter" onchange="filterUsers()" class="btn-secondary appearance-none px-4 py-2 rounded-lg text-sm font-medium pr-8 h-10">
                                    <option value="">All attributes</option>
                                    {% for a in all_attributes %}
                                    <option value="{{ a }}">{{ a }}</option>
                                    {% endfor %}
                                </select>
                                <span class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-notion-text-secondary">
                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor">
                                        <path d="M6 8l4 4 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                                    </svg>
                                </span>
                            </div>
                            <button type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center" onclick="bulkDeleteUsers()" aria-label="Bulk Delete">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </span>
                                <span>Bulk Delete</span>
                            </button>
                            <button type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center" onclick="openBulkAttrModal()" aria-label="Bulk Set Attributes">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                    </svg>
                                </span>
                                <span>Bulk Set Attributes</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 flex items-center space-x-2">
                        <input type="text" id="user-search" placeholder="Search users..." class="w-full px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text mb-2" onkeyup="filterUsers()">
                        <button type="button" onclick="document.getElementById('user-search').value='';document.getElementById('attr-filter').value='';filterUsers();" class="btn-secondary px-2 py-2 rounded text-sm" aria-label="Clear search">
                            &#10006;
                        </button>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <form id="user-bulk-form">
                        <table class="min-w-full divide-y divide-notion-border" id="users-table">
                            <thead>
                                <tr>
                                    <th class="px-2"><input type="checkbox" onclick="toggleAllUsers(this)" aria-label="Select all users"></th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">User</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Attributes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-notion-border">
                                {% for user, attrs in users.items() %}
                                <tr class="hover:bg-notion-hover transition">
                                    <td class="px-2"><input type="checkbox" name="user_bulk" value="{{ user }}" aria-label="Select user {{ user }}"></td>
                                    <td class="px-4 py-2 font-medium">{{ user }}</td>
                                    {# Normalize different user value shapes: dict with 'attributes', list, or string #}
                                    {% if attrs is mapping %}
                                        {% set attr_list = attrs.attributes or [] %}
                                    {% elif attrs is string %}
                                        {% set attr_list = [attrs] %}
                                    {% else %}
                                        {% set attr_list = attrs or [] %}
                                    {% endif %}
                                    <td class="px-4 py-2">{{ attr_list|join(', ') }}</td>
                                    <td class="px-4 py-2">
                                        <div class="flex flex-col items-start space-y-1">
                                            {# Escape single quotes for safe insertion into onclick string #}
                                            {% set attr_str = (attr_list|join(', '))|replace("'", "\\'") %}
                                            <a href="javascript:void(0)" onclick="openEditUserModal('{{ user }}', '{{ attr_str }}')" class="text-notion-accent hover:underline" aria-label="Edit user {{ user }}">Edit</a>
                                            <a href="javascript:void(0)" class="text-red-500 hover:underline" onclick="if(confirm('Delete user?')) deleteUser('{{ user }}'); return false;" aria-label="Delete user {{ user }}">Delete</a>
                                            <a href="javascript:void(0)" onclick="forceLogoutUser('{{ user }}')" class="text-yellow-400 hover:underline" title="Force logout" aria-label="Force logout {{ user }}">Logout</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="user-no-results" class="text-notion-text-secondary text-center py-4 hidden">No users found.</div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- Policies Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-notion-text font-title flex items-center">
                                File Policies
                                <span title="Manage file access policies" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-sm mt-1">Set and manage file access policies.</p>
                        </div>
                        <button onclick="openPolicyModal()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span>Add Policy</span>
                        </button>
                    </div>
                    <div class="p-4 flex items-center space-x-2">
                        <input type="text" id="policy-search" placeholder="Search policies..." class="w-full px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text mb-2" onkeyup="filterPolicies()">
                        <button type="button" onclick="document.getElementById('policy-search').value='';filterPolicies();" class="btn-secondary px-2 py-2 rounded text-sm" aria-label="Clear search">
                            &#10006;
                        </button>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <form id="policy-bulk-form">
                        <table class="min-w-full divide-y divide-notion-border" id="policies-table">
                            <thead>
                                <tr>
                                    <th class="px-2"><input type="checkbox" onclick="toggleAllPolicies(this)" aria-label="Select all policies"></th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">File</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Policy</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Key</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-notion-border">
                                {% for file, policy_obj in policies.items() %}
                                <tr class="hover:bg-notion-hover transition">
                                    <td class="px-2"><input type="checkbox" name="policy_bulk" value="{{ file }}" aria-label="Select policy for {{ file }}"></td>
                                    <td class="px-4 py-2 font-medium">{{ file }}</td>
                                    <td class="px-4 py-2">{{ policy_obj.policy if policy_obj.policy else '' }}</td>
                                       <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2">
                                        <div class="flex flex-col items-start space-y-1">
                                                          <a href="javascript:void(0)" class="text-notion-accent hover:underline edit-policy-link" 
                                                              data-file="{{ file }}" 
                                                              data-policy="{{ policy_obj.policy or '' }}" 
                                                              aria-label="Edit policy for {{ file }}">
                                                              Edit
                                                          </a>
                                            <a href="javascript:void(0)" class="text-red-500 hover:underline" onclick="if(confirm('Delete policy?')) deletePolicy('{{ file }}'); return false;" aria-label="Delete policy for {{ file }}">Delete</a>
                                            <a href="javascript:void(0)" onclick="previewPolicyAccess('{{ file }}')" class="text-green-400 hover:underline" title="Preview access" aria-label="Preview access for {{ file }}">Preview</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="policy-no-results" class="text-notion-text-secondary text-center py-4 hidden">No policies found.</div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- File Management Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-notion-text font-title flex items-center">
                                Files
                                <span title="Manage uploaded files" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-sm mt-1">View and manage uploaded files.</p>
                        </div>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <table class="min-w-full divide-y divide-notion-border">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">File Name</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Size</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Owner</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Upload Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-notion-border">
                                {% for file in all_files %}
                                <tr class="hover:bg-notion-hover transition">
                                    <td class="px-4 py-2 font-medium">{{ file.name }}</td>
                                    <td class="px-4 py-2">{{ file.size }}</td>
                                    <td class="px-4 py-2">{{ file.owner }}</td>
                                    <td class="px-4 py-2">{{ file.upload_date }}</td>
                                    <td class="px-4 py-2">
                                        <div class="flex flex-col items-start space-y-1">
                                            <a href="/download/{{ file.name }}" class="text-notion-accent hover:underline" aria-label="Download {{ file.name }}">Download</a>
                                            <a href="javascript:void(0)" onclick="if(confirm('Delete file?')) deleteFile('{{ file.name }}'); return false;" class="text-red-500 hover:underline" aria-label="Delete {{ file.name }}">Delete</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="file-no-results" class="text-notion-text-secondary text-center py-4 hidden">No files found.</div>
                    </div>
                </div>
            </section>
        </div>
    <div class="mt-12 flex flex-col gap-8">
            <!-- Audit Logs -->
            <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow p-6">
                <h4 class="text-lg font-semibold text-notion-text font-title mb-2">Audit Logs</h4>
                <div class="overflow-x-auto max-h-80">
                    <table class="min-w-full divide-y divide-notion-border">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">User</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Action</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-notion-border">
                            {% for log in audit_logs %}
                            <tr class="hover:bg-notion-hover transition">
                                <td class="px-4 py-2">{{ log.time }}</td>
                                <td class="px-4 py-2">{{ log.user }}</td>
                                <td class="px-4 py-2">{{ log.action }}</td>
                                <td class="px-4 py-2">{{ log.details }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="log-no-results" class="text-notion-text-secondary text-center py-4 hidden">No logs found.</div>
                </div>
            </div>
            <!-- Attribute Management -->
            <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow p-6">
                <h4 class="text-lg font-semibold text-notion-text font-title mb-2">Attribute Management</h4>
                <form id="attr-form" class="flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <input type="text" id="new-attr" placeholder="Add new attribute..." class="flex-1 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text">
                        <button type="button" class="btn-primary px-3 py-2 rounded text-white" onclick="addAttribute()">Add</button>
                    </div>
                    <div class="flex flex-wrap gap-3 mt-2">
                        {% for attr in all_attributes %}
                        <span class="bg-notion-accent text-white px-4 py-2 rounded-full flex items-center shadow-sm transition-all duration-150 hover:bg-notion-accent-hover">
                            <span class="mr-2">{{ attr }}</span>
                            <button type="button"
                                class="ml-1 px-2 py-1 rounded-full bg-notion-card text-notion-text-secondary hover:bg-notion-hover hover:text-white transition"
                                onclick="removeAttribute('{{ attr }}')"
                                aria-label="Remove attribute {{ attr }}">
                                &times;
                            </button>
                        </span>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>
    </main>
<!-- Modals for Add/Edit User, Policy, Bulk Actions, Preview, etc. -->
<div id="modal-root"></div>
<script>
// Utility: Show modal
function showModal(html) {
    const root = document.getElementById('modal-root');
    root.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" onclick="closeModal(event)">
        <div class="bg-notion-card p-6 rounded-xl shadow-xl min-w-[320px] max-w-lg relative animate-fade-in" onclick="event.stopPropagation();">
            <button onclick="closeModal()" class="absolute top-2 right-2 text-notion-text-secondary">&times;</button>
            ${html}
        </div>
    </div>`;
}
function closeModal(e) {
    if (!e || e.target === e.currentTarget) {
        document.getElementById('modal-root').innerHTML = '';
    }
}

// User search/filter
function filterUsers() {
    const input = document.getElementById('user-search').value.toLowerCase();
    // support comma-separated attribute filters (e.g. "a, b") and require all tokens to match
    const attrFilter = document.getElementById('attr-filter').value.toLowerCase();
    const rows = document.querySelectorAll('#users-table tbody tr');
    rows.forEach(row => {
        const user = row.children[1].textContent.toLowerCase();
        const attrs = row.children[2].textContent.toLowerCase();
        const matchesText = user.includes(input) || attrs.includes(input);
        // compute attribute tokens from the row and from the filter
        const rowAttrs = attrs.split(',').map(s => s.trim()).filter(Boolean);
        const filterTokens = attrFilter.split(',').map(s => s.trim()).filter(Boolean);
        const matchesAttr = filterTokens.length === 0 || filterTokens.every(tok => rowAttrs.includes(tok));
        row.style.display = (matchesText && matchesAttr) ? '' : 'none';
    });
}
function toggleAllUsers(source) {
    document.querySelectorAll('input[name="user_bulk"]').forEach(cb => cb.checked = source.checked);
}
function bulkDeleteUsers() {
    const selected = Array.from(document.querySelectorAll('input[name="user_bulk"]:checked')).map(cb => cb.value);
    if (!selected.length) return alert('Select users to delete.');
    if (!confirm('Delete selected users?')) return;
    fetch('/admin/bulk_delete_users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ users: selected })
    }).then(r => r.json()).then(res => {
        if (res.success) selected.forEach(u => {
            const row = document.querySelector(`#users-table input[value="${u}"]`).closest('tr');
            row.remove();
        });
        else alert('Error deleting users');
    });
}
function openBulkAttrModal() {
    showModal(`<h3 class='text-lg font-bold mb-2'>Bulk Set Attributes</h3>
        <form id='bulk-attr-form'>
            <input type='text' name='attrs' placeholder='Comma separated attributes' class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <button type='submit' class='btn-primary px-4 py-2 rounded text-white'>Set Attributes</button>
        </form>`);
    document.getElementById('bulk-attr-form').onsubmit = function(e) {
        e.preventDefault();
        const attrs = this.attrs.value;
        const selected = Array.from(document.querySelectorAll('input[name="user_bulk"]:checked')).map(cb => cb.value);
        fetch('/admin/bulk_set_attrs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ users: selected, attrs })
        }).then(r => r.json()).then(res => {
            if (res.success) window.location.reload();
            else alert('Error setting attributes');
        });
    };
}
function openUserModal() {
    showModal(`<h3 class='text-lg font-bold mb-2'>Add User</h3>
        <form id='add-user-form'>
            <input type='text' name='user' placeholder='Username' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <input type='text' name='attrs' placeholder='Comma separated attributes' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <button type='submit' class='btn-primary px-4 py-2 rounded text-white'>Add</button>
        </form>`);
    document.getElementById('add-user-form').onsubmit = function(e) {
        e.preventDefault();
        fetch('/admin/add_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: this.user.value, attrs: this.attrs.value })
        }).then(r => r.json()).then(res => {
            if (res.success) window.location.reload();
            else alert('Error adding user');
        });
    };
}
function openEditUserModal(user, attrs) {
    showModal(`<h3 class='text-lg font-bold mb-2'>Edit User</h3>
        <form id='edit-user-form'>
            <input type='text' name='user' value='${user}' readonly class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <input type='text' name='attrs' value='${attrs}' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <button type='submit' class='btn-primary px-4 py-2 rounded text-white'>Save</button>
        </form>`);
    document.getElementById('edit-user-form').onsubmit = function(e) {
        e.preventDefault();
        fetch('/admin/edit_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: this.user.value, attrs: this.attrs.value })
        }).then(r => r.json()).then(res => {
            if (res.success) window.location.reload();
            else alert('Error editing user');
        });
    };
}
function forceLogoutUser(user) {
    fetch('/admin/force_logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user })
    }).then(r => r.json()).then(res => {
        if (res.success) alert('User logged out');
        else alert('Error');
    });
}

// Policy search/filter
function filterPolicies() {
    const input = document.getElementById('policy-search').value.toLowerCase();
    const rows = document.querySelectorAll('#policies-table tbody tr');
    rows.forEach(row => {
        const file = row.children[1].textContent.toLowerCase();
        const policy = row.children[2].textContent.toLowerCase();
        row.style.display = (file.includes(input) || policy.includes(input)) ? '' : 'none';
    });
}
function toggleAllPolicies(source) {
    document.querySelectorAll('input[name="policy_bulk"]').forEach(cb => cb.checked = source.checked);
}
function bulkDeletePolicies() {
    const selected = Array.from(document.querySelectorAll('input[name="policy_bulk"]:checked')).map(cb => cb.value);
    if (!selected.length) return alert('Select policies to delete.');
    if (!confirm('Delete selected policies?')) return;
    fetch('/admin/bulk_delete_policies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: selected })
    }).then(r => r.json()).then(res => {
        if (res.success) selected.forEach(f => {
            const row = document.querySelector(`#policies-table input[value="${f}"]`).closest('tr');
            row.remove();
        });
        else alert('Error deleting policies');
    });
}
function openPolicyModal() {
    showModal(`<h3 class='text-lg font-bold mb-2'>Add Policy</h3>
        <form id='add-policy-form'>
            <input type='text' name='file' placeholder='File name' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <input type='text' name='policy' placeholder='Comma separated attributes' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <button type='submit' class='btn-primary px-4 py-2 rounded text-white'>Add</button>
        </form>`);
    document.getElementById('add-policy-form').onsubmit = function(e) {
        e.preventDefault();
        // POST form-encoded to the server route which expects form data
        fetch('/admin/add_policy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ file: this.file.value, policy: this.policy.value }).toString()
        }).then(() => window.location.reload()).catch(() => alert('Error adding policy'));
    };
}
function openEditPolicyModal(file, policy, key) {
    showModal(`<h3 class='text-lg font-bold mb-2'>Edit Policy</h3>
        <form id='edit-policy-form'>
            <input type='text' name='file' value='${file}' readonly class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <input type='text' name='policy' value='${policy}' required class='w-full mb-3 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text'>
            <button type='submit' class='btn-primary px-4 py-2 rounded text-white'>Save</button>
        </form>`);
    document.getElementById('edit-policy-form').onsubmit = function(e) {
        e.preventDefault();
        // POST to the server route that accepts the filename in the URL
        const target = '/admin/edit_policy/' + encodeURIComponent(this.file.value);
        const form = this;
        fetch(target, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            body: new URLSearchParams({ policy: this.policy.value }).toString()
        }).then(async res => {
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                const err = data && data.error ? data.error : 'Error editing policy';
                showInlineError(form, err);
                return;
            }
            const data = await res.json().catch(() => ({}));
            if (data && data.success) {
                // update the policies table cell for this file
                const fileName = form.file.value;
                const rows = document.querySelectorAll('#policies-table tbody tr');
                rows.forEach(r => {
                    if (r.querySelector('input[name="policy_bulk"]') && r.querySelector('input[name="policy_bulk"]').value === fileName) {
                        const policyCell = r.children[2];
                        if (policyCell) policyCell.textContent = form.policy.value;
                    }
                });
                closeModal();
            } else {
                const err = (data && data.error) ? data.error : 'Error editing policy';
                showInlineError(form, err);
            }
        }).catch(() => showInlineError(form, 'Network error'));
    };
}

// show inline error inside modal form
function showInlineError(form, message) {
    let err = form.querySelector('.inline-error');
    if (!err) {
        err = document.createElement('div');
        err.className = 'inline-error text-red-400 text-sm mt-2';
        form.appendChild(err);
    }
    err.textContent = message;
}

// Attach event listeners for edit policy links (after DOM loaded)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.edit-policy-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const file = this.getAttribute('data-file');
            const policy = this.getAttribute('data-policy');
            openEditPolicyModal(file, policy);
        });
    });
});
function previewPolicyAccess(file) {
    showModal(`<h3 class='text-lg font-bold mb-2'>Preview Access</h3><div>Users who match policy for <b>${file}</b> (not implemented)</div>`);
}
function deleteFile(filename) {
    fetch('/admin/delete_file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename })
    }).then(r => r.json()).then(res => {
        if (res.success) window.location.reload();
        else alert('Error deleting file');
    });
}
function deleteUser(user) {
    fetch('/admin/delete_user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user })
    }).then(r => r.json()).then(res => {
        if (res.success) {
            const row = document.querySelector(`#users-table input[value="${user}"]`)
            if (row) row.closest('tr').remove();
        } else {
            alert('Error deleting user');
        }
    });
}
function deletePolicy(file) {
    fetch('/admin/delete_policy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ file })
    }).then(r => r.json()).then(res => {
        if (res.success) {
            const row = document.querySelector(`#policies-table input[value="${file}"]`)
            if (row) row.closest('tr').remove();
        } else {
            alert('Error deleting policy');
        }
    });
}
function addAttribute() {
    const attr = document.getElementById('new-attr').value;
    fetch('/admin/add_attribute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ attr })
    }).then(r => r.json()).then(res => {
        if (res.success) window.location.reload();
        else alert('Error adding attribute');
    });
}
function removeAttribute(attr) {
    fetch('/admin/remove_attribute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ attr })
    }).then(r => r.json()).then(res => {
        if (res.success) window.location.reload();
        else alert('Error removing attribute');
    });
}
</script>
</body>
</html>
