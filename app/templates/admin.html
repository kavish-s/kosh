<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kosh</title>
    
    <!-- Favicon and Web App Manifest -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    <link rel="manifest" href="/static/site.webmanifest">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="/static/css/admin.css">
    
    <!-- External Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <!-- Tailwind Configuration -->
    <script src="/static/js/config/tailwind.config.js"></script>
    
</head>
<body class="bg-notion-bg text-notion-text font-content min-h-screen">
    <!-- Top Navigation -->
    <nav class="border-b border-notion-border bg-notion-bg/95 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg overflow-hidden flex items-center justify-center">
                        <img src="/static/android-chrome-512x512.png" alt="Kosh Logo" class="w-full h-full object-cover">
                    </div>
                    <h1 class="text-xl font-semibold text-notion-text font-title">Kosh Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-notion-accent hover:text-white flex items-center space-x-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        <span>User Dashboard</span>
                    </a>
                    <a href="/logout" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-notion-text hover:text-white flex items-center space-x-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Sign out</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8 animate-slide-up">
        <div class="mb-12">
            <h2 class="text-3xl font-bold text-notion-text mb-2 font-title">Admin Dashboard</h2>
            <p class="text-notion-text-secondary text-lg font-content">Manage all users, attributes, and file policies on the network.</p>
        </div>
        
        <div class="flex flex-col gap-8">
            <!-- Users Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="mb-2 md:mb-0">
                            <h3 class="text-2xl font-semibold text-notion-text font-title flex items-center mb-2">
                                Users & Attributes
                                <span title="Manage users and their attributes" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-base mt-1">Add, edit, or remove users and set their attributes.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <button onclick="openUserModal()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center" aria-label="Add User">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </span>
                                <span>Add User</span>
                            </button>
                            <button onclick="bulkDeleteUsers()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center" aria-label="Bulk Delete Users">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </span>
                                <span>Bulk Delete</span>
                            </button>
                            <button type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center" onclick="openBulkAttrModal()" aria-label="Bulk Set Attributes">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <i data-lucide="list" class="w-4 h-4"></i>
                                </span>
                                <span>Bulk Set Attributes</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col gap-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="user-search" placeholder="Search users..." class="flex-1 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text" onkeyup="filterUsers()">
                            <input type="text" id="attr-filter" placeholder="Filter by attributes..." class="flex-1 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text" onkeyup="filterUsers()">
                            <button type="button" onclick="document.getElementById('user-search').value='';document.getElementById('attr-filter').value='';filterUsers();" class="btn-secondary px-3 py-2 rounded text-sm" aria-label="Clear search">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="text-xs text-notion-text-secondary">
                            <span class="mr-4">ðŸ’¡ Tip: Use Ctrl+K to focus search</span>
                            <span id="user-count-status">Showing all users</span>
                        </div>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <form id="user-bulk-form">
                            <table class="min-w-full divide-y divide-notion-border" id="users-table">
                                <thead>
                                    <tr>
                                        <th class="px-2 py-3 text-left">
                                            <input type="checkbox" onclick="toggleAllUsers(this)" aria-label="Select all users" class="rounded border-notion-border bg-notion-input">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">User</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Attributes</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-notion-border" id="users-tbody">
                                    {% for user, attrs in users.items() %}
                                    <tr class="hover:bg-notion-hover transition-colors duration-150">
                                        <td class="px-2 py-3">
                                            <input type="checkbox" name="user_bulk" value="{{ user }}" aria-label="Select user {{ user }}" class="rounded border-notion-border bg-notion-input">
                                        </td>
                                        <td class="px-4 py-3 font-medium text-notion-text">{{ user }}</td>
                                        {# Normalize different user value shapes: dict with 'attributes', list, or string #}
                                        {% if attrs is mapping %}
                                            {% set attr_list = attrs.get('attributes') if attrs.get('attributes') is not none else attrs %}
                                        {% elif attrs is string %}
                                            {% set attr_list = [attrs] %}
                                        {% else %}
                                            {% set attr_list = attrs or [] %}
                                        {% endif %}
                                        <td class="px-4 py-3">
                                            <div class="flex flex-wrap gap-1">
                                                {% for attr in attr_list %}
                                                <span class="inline-flex px-2 py-1 text-xs rounded-full bg-notion-accent/20 text-notion-accent">{{ attr }}</span>
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex flex-col sm:flex-row items-start space-y-1 sm:space-y-0 sm:space-x-2">
                                                {# Build a safe attribute string for HTML attributes (escape single quotes) #}
                                                {% set attr_str = attr_list|join(', ') %}
                                                <button type="button" class="btn-action btn-action-edit edit-user-link" 
                                                       data-user='{{ user|replace("'", "&#39;") }}' 
                                                       data-attrs='{{ attr_str|replace("'", "&#39;") }}' 
                                                       aria-label="Edit user {{ user }}"
                                                       title="Edit user">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button type="button" class="btn-action btn-action-delete delete-user-link" 
                                                       data-user='{{ user|replace("'", "&#39;") }}' 
                                                       aria-label="Delete user {{ user }}"
                                                       title="Delete user">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div id="user-no-results" class="text-notion-text-secondary text-center py-8 hidden">
                                <div class="text-lg mb-2">No users found</div>
                                <div class="text-sm">Try adjusting your search criteria</div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- Policies Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-xl font-semibold text-notion-text font-title flex items-center">
                                File Policies
                                <span title="Manage file access policies" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-sm mt-1">Set and manage file access policies.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <button onclick="openPolicyModal()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center space-x-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Add Policy</span>
                            </button>
                            <button onclick="bulkDeletePolicies()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center" aria-label="Bulk Delete Policies">
                                <span class="inline-flex w-5 h-5 items-center justify-center mr-2">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </span>
                                <span>Bulk Delete</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 flex items-center space-x-2">
                        <input type="text" id="policy-search" placeholder="Search policies..." class="flex-1 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text" onkeyup="filterPolicies()">
                        <button type="button" onclick="document.getElementById('policy-search').value='';filterPolicies();" class="btn-secondary px-3 py-2 rounded text-sm" aria-label="Clear search">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <form id="policy-bulk-form">
                            <table class="min-w-full divide-y divide-notion-border" id="policies-table">
                                <thead>
                                    <tr>
                                        <th class="px-2 py-3 text-left">
                                            <input type="checkbox" onclick="toggleAllPolicies(this)" aria-label="Select all policies" class="rounded border-notion-border bg-notion-input">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">File</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Policy</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Key</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-notion-border">
                                    {% for file, policy_obj in policies.items() %}
                                    <tr class="hover:bg-notion-hover transition-colors duration-150">
                                        <td class="px-2 py-3">
                                            <input type="checkbox" name="policy_bulk" value="{{ file }}" aria-label="Select policy for {{ file }}" class="rounded border-notion-border bg-notion-input">
                                        </td>
                                        <td class="px-4 py-3 font-medium text-notion-text">{{ file }}</td>
                                        <td class="px-4 py-3">
                                            {% if policy_obj.policy %}
                                                <div class="flex flex-wrap gap-1">
                                                    {% for attr in policy_obj.policy.split(',') %}
                                                    <span class="inline-flex px-2 py-1 text-xs rounded-full bg-notion-accent/20 text-notion-accent">{{ attr.strip() }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <span class="text-notion-text-secondary italic">No policy set</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 text-notion-text-secondary">
                                            {{ policy_obj.key if policy_obj.key else 'Auto-generated' }}
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex flex-col sm:flex-row items-start space-y-1 sm:space-y-0 sm:space-x-2">
                                                <button type="button" class="btn-action btn-action-edit edit-policy-link" 
                                                    data-file="{{ file }}" 
                                                    data-policy="{{ policy_obj.policy or '' }}" 
                                                    aria-label="Edit policy for {{ file }}"
                                                    title="Edit policy">
                                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                </button>
                                                <button type="button" class="btn-action btn-action-delete" onclick="if(confirm('Delete policy?')) deletePolicy('{{ file }}'); return false;" aria-label="Delete policy for {{ file }}" title="Delete policy">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div id="policy-no-results" class="text-notion-text-secondary text-center py-8 hidden">
                                <div class="text-lg mb-2">No policies found</div>
                                <div class="text-sm">Try adjusting your search criteria</div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- File Management Section -->
            <section class="h-full flex flex-col mb-8">
                <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow animate-scale-in h-full flex flex-col">
                    <div class="p-6 border-b border-notion-border flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-notion-text font-title flex items-center">
                                Files
                                <span title="Manage uploaded files" class="ml-2 text-notion-accent cursor-help">&#9432;</span>
                            </h3>
                            <p class="text-notion-text-secondary text-sm mt-1">View and manage uploaded files.</p>
                        </div>
                    </div>
                    <div class="p-6 flex-1 overflow-x-auto">
                        <table class="min-w-full divide-y divide-notion-border">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">File Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Size</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Owner</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Upload Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-notion-border">
                                {% for file in all_files %}
                                <tr class="hover:bg-notion-hover transition-colors duration-150">
                                    <td class="px-4 py-3 font-medium text-notion-text">{{ file.name }}</td>
                                    <td class="px-4 py-3 text-notion-text-secondary">{{ file.size }}</td>
                                    <td class="px-4 py-3 text-notion-text-secondary">{{ file.owner }}</td>
                                    <td class="px-4 py-3 text-notion-text-secondary">{{ file.upload_date }}</td>
                                    <td class="px-4 py-3">
                                        <div class="flex flex-col sm:flex-row items-start space-y-1 sm:space-y-0 sm:space-x-2">
                                            <a href="/download/{{ file.name }}" class="btn-action btn-action-download" aria-label="Download {{ file.name }}" title="Download file">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </a>
                                            <button type="button" onclick="if(confirm('Delete file?')) deleteFile('{{ file.name }}'); return false;" class="btn-action btn-action-delete" aria-label="Delete {{ file.name }}" title="Delete file">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-notion-text-secondary">
                                        <div class="text-lg mb-2">No files uploaded yet</div>
                                        <div class="text-sm">Files will appear here once uploaded</div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="mt-12 flex flex-col gap-8">
            <!-- Audit Logs -->
            <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow p-6">
                <h4 class="text-lg font-semibold text-notion-text font-title mb-2">Audit Logs</h4>
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <label class="text-sm text-notion-text-secondary">From:
                        <input type="date" id="audit-from" class="ml-2 px-2 py-1 rounded border border-notion-border bg-notion-input text-notion-text" onchange="filterAuditLogs()">
                    </label>
                    <label class="text-sm text-notion-text-secondary">To:
                        <input type="date" id="audit-to" class="ml-2 px-2 py-1 rounded border border-notion-border bg-notion-input text-notion-text" onchange="filterAuditLogs()">
                    </label>
                    <button type="button" class="btn-secondary px-3 py-1 rounded text-sm" onclick="document.getElementById('audit-from').value='';document.getElementById('audit-to').value='';filterAuditLogs();">Clear</button>
                </div>
                <div class="overflow-x-auto max-h-80">
                    <table class="min-w-full divide-y divide-notion-border" id="audit-table">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">User</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Action</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-notion-text-secondary uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-notion-border" id="audit-tbody">
                            {% for log in audit_logs %}
                            <tr class="hover:bg-notion-hover transition">
                                <td class="px-4 py-2">{{ log.time }}</td>
                                <td class="px-4 py-2">{{ log.user }}</td>
                                <td class="px-4 py-2">{{ log.action }}</td>
                                <td class="px-4 py-2">{{ log.details }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="log-no-results" class="text-notion-text-secondary text-center py-4 hidden">No logs found.</div>
                </div>
            </div>
            <!-- Attribute Management -->
            <div class="bg-notion-card border border-notion-border rounded-xl notion-shadow p-6">
                <h4 class="text-lg font-semibold text-notion-text font-title mb-2">Attribute Management</h4>
                <form id="attr-form" class="flex flex-col space-y-2" onsubmit="return false;">
                    <div class="flex space-x-2">
                        <input type="text" id="new-attr" name="new-attr" placeholder="Add new attribute..." class="flex-1 px-3 py-2 rounded border border-notion-border bg-notion-input text-notion-text" onkeydown="if(event.key==='Enter'){event.preventDefault();addAttribute();}">
                        <button type="button" class="btn-primary px-3 py-2 rounded text-white" onclick="addAttribute()">Add</button>
                    </div>
                    <div class="flex flex-wrap gap-3 mt-2">
                        {% for attr in all_attributes %}
                        <span class="bg-notion-accent/20 text-notion-accent px-3 py-2 rounded-full flex items-center shadow-sm transition-all duration-150 hover:bg-notion-accent/30">
                            <span class="mr-2">{{ attr }}</span>
                            <button type="button"
                                class="ml-1 px-2 py-1 rounded-full bg-notion-card text-notion-text-secondary hover:bg-notion-hover hover:text-white transition"
                                onclick="removeAttribute('{{ attr }}')"
                                aria-label="Remove attribute {{ attr }}">
                                &times;
                            </button>
                        </span>
                        {% endfor %}
                    </div>
                </form>
                    <div id="attr-error" class="text-red-400 text-sm mt-2" style="display:none;"></div>
            </div>
        </div>
    </main>

    <!-- Modals and Toast Root -->
    <div id="modal-root"></div>
    <div id="toast-root" class="fixed bottom-6 right-6 z-50 space-y-2 pointer-events-none"></div>

    <!-- Global Data for JavaScript -->
    <script>
        // Make allAttributes available globally for modals
        window.allAttributes = {{ all_attributes|tojson|safe }};
    </script>

    <!-- Core JavaScript Modules -->
    <script src="/static/js/utils/ui-helpers.js"></script>
    <script src="/static/js/components/modal.js"></script>
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/modules/user-manager.js"></script>
    <script src="/static/js/modules/policy-manager.js"></script>
    <script src="/static/js/modules/attribute-manager.js"></script>
    <script src="/static/js/modules/audit-manager.js"></script>
    <script src="/static/js/modules/file-manager.js"></script>
    <script src="/static/js/modules/realtime-manager.js"></script>
    <script src="/static/js/utils/admin-links.js"></script>
    
    <!-- Main Dashboard Initialization -->
    <script src="/static/js/admin-dashboard.js"></script>

</body>
</html>
